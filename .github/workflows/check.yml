name: Debug Step by Step
on: push
jobs:
  debug:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup
        run: |
          cd backend/main-service
          go mod download
          
          # Создаем .env
          cat > .env << 'EOF'
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
EOF
      
      - name: Run minimal test
        run: |
          cd backend/main-service
          
          # Тестовый main только с Redis
          cat > test_redis.go << 'EOF'
          package main
          
          import (
              "context"
              "fmt"
              "os"
              "time"
              
              "main-service/internal/database"
              "github.com/sirupsen/logrus"
          )
          
          func main() {
              fmt.Fprintf(os.Stderr, "=== TEST START: %v ===\n", time.Now())
              
              logger := logrus.New()
              logger.SetLevel(logrus.DebugLevel)
              
              fmt.Fprintln(os.Stderr, "STEP 1: Calling database.Init()")
              redisClient := database.Init(logger)
              
              if redisClient == nil {
                  fmt.Fprintln(os.Stderr, "ERROR: Redis client is nil")
                  os.Exit(1)
              }
              
              fmt.Fprintln(os.Stderr, "STEP 2: Testing Redis connection")
              ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
              defer cancel()
              
              if err := redisClient.Ping(ctx).Err(); err != nil {
                  fmt.Fprintf(os.Stderr, "ERROR: Redis ping failed: %v\n", err)
                  os.Exit(1)
              }
              
              fmt.Fprintln(os.Stderr, "SUCCESS: Redis connected")
              fmt.Fprintln(os.Stderr, "=== TEST END ===")
          }
          EOF
          
          go run test_redis.go 2>&1