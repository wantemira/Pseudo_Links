name: Debug Server
on: push
jobs:
  debug:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup
        run: |
          cd backend/main-service
          go mod download
      
      - name: Check Redis
        run: |
          echo "=== REDIS CHECK ==="
          redis-cli -h localhost -p 6379 ping || echo "Redis ping failed"
      
      - name: Run server and FULL diagnostics
        run: |
          cd backend/main-service
          echo "=== STEP 1: RUN SERVER ==="
          
          # Запускаем сервер с полным логированием
          go run main.go > complete_debug.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Ждем 5 секунд
          sleep 5
          
          echo "=== STEP 2: CHECK PROCESS STATUS ==="
          if ps -p $SERVER_PID > /dev/null; then
            echo "✅ Server process IS ALIVE"
          else
            echo "❌ Server process DIED"
          fi
          
          echo "=== STEP 3: CHECK SERVER LOGS ==="
          echo "--- First 30 lines ---"
          head -30 complete_debug.log
          echo "--- Last 30 lines ---"
          tail -30 complete_debug.log
          
          echo "=== STEP 4: CHECK ALL PORTS ==="
          echo "Listening ports:"
          ss -tulpn 2>/dev/null || netstat -tulpn 2>/dev/null || echo "Cannot list ports"
          
          echo "=== STEP 5: CHECK SPECIFIC PROCESS PORTS ==="
          echo "Ports for PID $SERVER_PID:"
          ss -tulp 2>/dev/null | grep "pid=$SERVER_PID" || \
          netstat -tulp 2>/dev/null | grep "$SERVER_PID/" || \
          echo "Cannot find ports for this PID"
          
          echo "=== STEP 6: CHECK IF GIN SERVER STARTED ==="
          echo "Looking for GIN debug messages..."
          grep -i "gin\|listen\|server\|port\|8080" complete_debug.log | head -20 || echo "No GIN messages"
          
          echo "=== STEP 7: KILL SERVER ==="
          kill $SERVER_PID 2>/dev/null || true